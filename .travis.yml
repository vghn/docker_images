language: ruby
rvm: 2.2
services: docker
cache:
  directories:
    - vendor/bundle
branches:
  except:
    - /^v\d/
env:
  - IMAGE=api
  - IMAGE=server
before_install:
  - sudo apt-get -qy update
  - sudo apt-get -qy -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install docker-engine
install: bundle install --path vendor/bundle
script: bundle exec rake ${IMAGE}:spec
before_deploy: docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
deploy:
  provider: script
  script: bundle exec rake ${IMAGE}:publish
  skip_cleanup: true
  on:
    all_branches: true
